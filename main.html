<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Robot control</title>
</head>
<body>

<p>Please enter the offer provided to you by the sender application: </p>
<textarea cols="80" rows="25"></textarea>
<button>Submit</button>

<video id="video-element" muted></video>

<p>Enter a number to send</p>
<input type="number" id="numberInput" value="0">
<button id="sendNumber">Send Number</button>

<script>
    let dataChannel;

    document.querySelector('button').addEventListener('click', async () => {
        const offer = JSON.parse(document.querySelector('textarea').value);
        const pc = new RTCPeerConnection({
            // Recommended for libdatachannel
            bundlePolicy: 'max-bundle',
        });

        pc.onicegatheringstatechange = (state) => {
            if (pc.iceGatheringState === 'complete') {
                // We only want to provide an answer once all of our candidates have been added to the SDP.
                const answer = pc.localDescription;
                document.querySelector('textarea').value = JSON.stringify({"type": answer.type, sdp: answer.sdp});
                document.querySelector('p').value = 'Please paste the answer in the sender application.';
                alert('Please paste the answer in the sender application.');
            }
        }

        pc.ontrack = (evt) => {
            const videoElement = document.getElementById('video-element');
            videoElement.srcObject = evt.streams[0];
            videoElement.play();
        };

        await pc.setRemoteDescription(offer);

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        pc.ondatachannel = (evt) => {
            dataChannel = evt.channel;
            console.log('Data channel received:', dataChannel.label)
            if (dataChannel.label === "numberChannel") {
                dataChannel.onopen = () => {
                    console.log('Data channel open');
                };
                dataChannel.onmessage = (evt) => {
                    console.log('Received message:', evt.data);
                };
            } else {
                console.log('Unknown data channel');
            }
        };
    })

    document.querySelector('#sendNumber').addEventListener('click', () => {
        const numberValue = document.querySelector('#numberInput').value;
        if (dataChannel && dataChannel.readyState === 'open') {
            dataChannel.send(numberValue);
            console.log("Sent number: " + numberValue);
        } else {
            console.log("Data channel is not open");
        }
    });
</script>
</body>
</html>